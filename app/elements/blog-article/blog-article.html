<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../styles/shared-styles.html">


<dom-module id="blog-article">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      :host {
        display: block;
      }
      .mainCard {
        padding: 0;
        background: var(--article-card-background, white);
        overflow: auto;
        margin-left: auto;
        margin-right: auto;
      }
      
      @media (min-width: 1200px) {
        .mainCard {
          width: 70%;
        }
      }
    </style>

  <iron-ajax
    id="articleGetter"
    handle-as="json"
    on-response="_handleResponse"
    on-error="_handleError"
    url="{{article-api-url}}/{{articleurl}}">
  </iron-ajax>
  <paper-material elevation="4" class="mainCard">
    <div class="article_content" id="articleBody">
      <template is="dom-if" if="{{display404}}">
        <h1 style="text-align: center">404</h1>
        <h2 style="text-align: center">Article not found.</h2>
      </template>
      <template is="dom-if" if="{{articleContent}}">
        <h1>{{title}}</h1>
        <div><b>Par:&nbsp;</b>{{author}}&nbsp;&nbsp;<b>Post√© le:&nbsp;</b>{{date}}</div>
        <br />
      </template>
    </div>
  </paper-material>
  </template>
  
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'blog-article',

      properties: {
        'articleurl': {
          type: String,
          notify: true,
          observer: '_articleChanged'
        },
        'display404': {
          type: Boolean,
          notify: true,
          value: false
        },
        'articleContent': {
          type: String,
          notify: true
        },
        'title': {
          type: String,
          notify: true
        },
        'author': {
          type: String,
          notify: true
        },
        'date': {
          type: String,
          notify: true
        }
      },
      _articleChanged: function() {
        // Fire AJAX request
        console.log('Were in value changed for article' + this.articleurl);
        this.$.articleGetter.generateRequest();
      },
      _handleError: function() {
        // TODO I could handle any kind of error by using a parameter e to get the
        // event and check what happened, but I'm going to assume 404 for the moment.
        this.display404 = true;
        console.log('Handled an error with the article');
        this.articleContent = '';
      },
      _handleResponse: function(e) {
        // I'm not using last-response in the component because I want
        // to perform transformations on the body of the article, client-side.
        console.log(e.detail.response);
        this.title = e.detail.response.title;
        this.author = e.detail.response.author;
        this.date = e.detail.response.date;
        this.articleContent = e.detail.response.content;
        var contentDiv = document.createElement('div');
        contentDiv.innerHTML = this.articleContent;
        this.$.articleBody.appendChild(contentDiv);
      },
      _processArticle: function(article) {
        // We need to find all the Hx elements and generate the table of content using that.
        
      }
      
    });
  })();
  </script>
</dom-module>
